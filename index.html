<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>災害情報 AIマッチングシステム</title>
    <link href="[https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css](https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css)" rel="stylesheet">
    <link href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css)" rel="stylesheet">
    <link rel="stylesheet" href="[https://unpkg.com/leaflet@1.9.4/dist/leaflet.css](https://unpkg.com/leaflet@1.9.4/dist/leaflet.css)" />

    <style>
        body { height: 100vh; overflow: hidden; font-family: 'Helvetica Neue', Arial, sans-serif; background-color: #f0f2f5; }
        .main-wrapper { display: flex; height: 100vh; }
        
        /* 左パネル (リスト) */
        .left-panel {
            width: 500px;
            background-color: #ffffff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 500;
        }
        .panel-header { padding: 20px; border-bottom: 1px solid #eee; background: #fff; }
        .panel-scroll { flex-grow: 1; overflow-y: auto; padding: 20px; background: #f8f9fa; }
        
        /* 右パネル (地図) */
        .right-panel { flex-grow: 1; position: relative; }
        #map { height: 100%; width: 100%; }

        /* デザインパーツ */
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            background: #fdfdfd;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
        }
        .upload-area:hover { background-color: #f1f5f9; border-color: #6366f1; }

        .match-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #eee;
            cursor: pointer;
            transition: 0.2s;
        }
        .match-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: #6366f1; }
        
        .score-badge { font-size: 12px; font-weight: bold; padding: 4px 10px; border-radius: 20px; color: white; }
        .score-high { background: linear-gradient(45deg, #ff6b6b, #ee5253); }
        .score-mid { background: linear-gradient(45deg, #feca57, #ff9f43); }
        .score-low { background: linear-gradient(45deg, #54a0ff, #2e86de); }

        .data-source { font-size: 11px; color: #666; margin-top: 8px; padding: 10px; background: #f8f9fa; border-radius: 6px; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="left-panel">
        <div class="panel-header">
            <h5 class="fw-bold mb-3"><i class="fas fa-network-wired text-primary"></i> 災害情報マッチング</h5>
            
            {% if error %}
            <div class="alert alert-danger py-2 small">{{ error }}</div>
            {% endif %}

            <form method="POST" enctype="multipart/form-data">
                <label class="upload-area d-block">
                    <i class="fas fa-file-csv fa-2x text-secondary mb-2"></i><br>
                    <span class="fw-bold">CSVファイルをアップロード</span><br>
                    <small class="text-muted">SNSデータと業務データの2つを選択</small>
                    <input type="file" name="files" multiple accept=".csv" style="display:none;" onchange="this.form.submit()">
                </label>
            </form>
        </div>

        <div class="panel-scroll">
            {% if matches %}
                <p class="text-muted small mb-3">{{ matches|length }}件のマッチングが見つかりました</p>
                
                {% for match in matches %}
                <div class="match-card" onclick="flyToMap({{ match.lat }}, {{ match.lng }})">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-light text-dark border">{{ match.location_label }}</span>
                        <span class="score-badge {% if match.score >= 80 %}score-high{% elif match.score >= 60 %}score-mid{% else %}score-low{% endif %}">
                            スコア: {{ match.score }}%
                        </span>
                    </div>
                    
                    <h6 class="fw-bold mb-2">{{ match.event_type }}</h6>
                    <p class="small text-muted mb-2">{{ match.reason }}</p>
                    
                    <div class="data-source">
                        <div class="mb-1"><i class="fas fa-building text-primary"></i> <b>Chrono:</b> {{ match.chrono_info }}</div>
                        <div><i class="fab fa-twitter text-info"></i> <b>SNS:</b> {{ match.sns_info }}</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-map-marked-alt fa-3x mb-3 text-secondary" style="opacity:0.3;"></i><br>
                    データをアップロードすると<br>ここに分析結果が表示されます
                </div>
            {% endif %}
        </div>
    </div>

    <div class="right-panel">
        <div id="map"></div>
    </div>
</div>

<script src="[https://unpkg.com/leaflet@1.9.4/dist/leaflet.js](https://unpkg.com/leaflet@1.9.4/dist/leaflet.js)"></script>
<script>
    // 1. 地図初期化 (デフォルト: 福岡市役所周辺)
    var map = L.map('map').setView([33.590355, 130.401716], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 2. データ受け取り
    var matches = {{ matches | tojson }};

    if (matches && matches.length > 0) {
        var bounds = [];
        matches.forEach(function(m) {
            // スコアに応じた色の決定
            var color = (m.score >= 80) ? '#ff6b6b' : (m.score >= 60) ? '#feca57' : '#54a0ff';
            
            var customIcon = L.divIcon({
                className: 'custom-pin',
                html: `<div style="background:${color}; width:30px; height:30px; border-radius:50%; border:3px solid white; box-shadow:0 3px 5px rgba(0,0,0,0.3); text-align:center; color:white; line-height:24px; font-size:14px;">
                        <i class="fas fa-exclamation"></i>
                       </div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            // マーカー設置
            L.marker([m.lat, m.lng], {icon: customIcon})
                .addTo(map)
                .bindPopup(`
                    <b>${m.location_label} (${m.score}%)</b><br>
                    ${m.event_type}<br>
                    <small>${m.reason}</small>
                `);
            
            bounds.push([m.lat, m.lng]);
        });

        // ピンが全て見えるようにズーム調整
        if (bounds.length > 0) {
            map.fitBounds(bounds, {padding: [50, 50]});
        }
    }

    // 地図移動用関数
    function flyToMap(lat, lng) {
        if(lat && lng) {
            map.flyTo([lat, lng], 16, { animate: true, duration: 1.0 });
        }
    }
</script>
</body>
</html>